---
description: Core Task Management System
globs: 
alwaysApply: true
---
The MCP (Multi-Agent Coordination Platform) Task Management System is engineered as a **structured, scalable, and maintainable framework** for orchestrating tasks, projects, and AI agents in multi-agent environments. Its core purpose is to **ensure data integrity and automation**, mandating that **all operations are exclusively performed via dedicated MCP tools**.

## üèóÔ∏è **PROJECT STRUCTURE & DEPLOYMENT MODEL**

**IMPORTANT**: The `.cursor/rules/` directory structure described in this guide exists **ONLY in the dhafnck_mcp development project** (this repository). Other projects using the MCP server will **NOT have these directories**.

### @task_planning_agent need review all task then split task to subtask if no subtask is exist, last subtask is "call manage_context() for complete context data before complete task"

### **Deployment Architecture**
- **dhafnck_mcp**: The **ROOT/SOURCE** project containing the MCP server implementation
  - Contains `.cursor/rules/` with full directory structure
  - Will be built into Docker containers for distribution
- **Client Projects**: Projects using the dockerized MCP server
  - **NO `.cursor/rules/` directories** in client projects
  - Data is stored **remotely** in the Docker container or cloud infrastructure
  - Client projects only need MCP client configuration (e.g., `.cursor/mcp.json`)

### **Data Storage Locations**
- **Development (dhafnck_mcp)**: Local `.cursor/rules/` directories
- **Production/Docker**: Data stored within container or cloud storage
- **Client Projects**: No local data storage - all managed remotely via MCP protocol

### Key Features and Core Components

1.  **Tasks**: These are the **atomic units of work**.
    *   They are hierarchically stored in `/.cursor/rules/tasks/{user_id}/{project_id}/{task_tree_id}/tasks.json` **(in dhafnck_mcp development only)**. A legacy `tasks.json` format is supported but deprecated.
    *   **Required fields** for every task include `id`, `title`, `description`, `project_id`, `status`, `priority`, `created_at`, and `updated_at`.
    *   **Task IDs** follow a **date-based format**: `YYYYMMDDXXX` for main tasks (e.g., `20250617001`) and `YYYYMMDDXXX.XXX` for subtasks (e.g., `20250617001.001`). These IDs are **auto-generated by MCP tools**. **Always quote IDs** when using them in tool calls (e.g., `"20250617001"`).
    *   **Valid Status values** for tasks include: `todo`, `in_progress`, `review`, `done`, `cancelled`, `blocked`, `deferred`.

2.  **Projects**: These serve as **logical containers for related work**, each capable of holding one or more task trees.
    *   Project data is managed by MCP tools and stored in `/.cursor/rules/brain/projects.json` **(in dhafnck_mcp development only)**. **Direct editing of this file is prohibited**.
    *   Each project can have multiple **task trees** (e.g., "main", "feature-branch"), which organize tasks by branches, features, or workflows.

3.  **Agents**: These represent **specialized AI or human roles** that are assigned to projects, task trees, or individual tasks.
    *   Agent data is managed by MCP tools and stored in `/.cursor/rules/brain/projects.json`.
    *   Agent registration is **streamlined**, requiring only three essential fields: `id`, `name`, and `call_agent`. **Agent details (capabilities, behaviors) are automatically loaded from YAML configurations** in `yaml-lib/` when an agent is called.
    *   Agents are assigned to task trees via the `agent_assignments` mapping in the project object.
    *   **Agent configurations (YAML files)** must be kept up to date in `/yaml-lib/[agent_name]/`. Each agent needs a `job_desc.yaml` and at least one `rules/context` file.

4.  **Contexts**: This is a **JSON-based system for managing task contexts**.
    *   Contexts are stored hierarchically **(storage location varies by deployment)**
    *   Contexts can be **manually created** using `manage_context("create", ...)` tool - **MUST created and updated when complete task**
    *   A context contains crucial information such as `task_id`, `project_id`, `task_tree_id`, `status`, `assignees`, `title`, `description`, `next_steps`, and `notes` (for insights).
    *   **Agent insights** in notes should use specific categories: `insight`, `challenge`, `solution`, `decision`.

### Workflow for AI Reading

Here's a simplified workflow demonstrating interactions within the MCP Task Management System:

**I. System Initialization & Setup**
‚Üí **Create Project & Task Trees**
    ‚îú‚îÄ‚îÄ Use `manage_project("create", project_id="...", name="...")`.
    ‚îî‚îÄ‚îÄ Create task trees (branches/features) using `manage_project("create_tree", project_id="...", tree_id="...")`.
‚Üí **Register & Assign Agents**
    ‚îú‚îÄ‚îÄ **Simplified Agent Registration**: Use `manage_agent("register", name="...", call_agent="@...")` with only `id`, `name`, `call_agent` fields required.
    ‚îî‚îÄ‚îÄ **Agent Details Auto-loaded**: When an agent is called, its full capabilities and behaviors are automatically loaded. Agents are assigned to specific task trees via `manage_agent("assign", agent_id="...", project_id="...", tree_id="...")`.

**II. Task Lifecycle & Management**
‚Üí **Create Task (in Specific Project/Tree, ai no have permission to use it if no have demande of user, use next instead)**
    ‚îú‚îÄ‚îÄ Use `manage_task("create", project_id="...", task_tree_id="...", title="...", description="...")`.
    ‚îî‚îÄ‚îÄ **Assign Agent(s)**: In task assignees, **always use the `@` prefix** (e.g., `["@coding_agent"]`). The system automatically normalizes names by adding "@" if missing.
‚Üí **Retrieve Task / Get Next Recommended Task**
    ‚îú‚îÄ‚îÄ User calls `manage_task("get", task_id="...", project_id="...", task_tree_id="...")` or `manage_task("next", ...)`.
    ‚îú‚îÄ‚îÄ System loads task data and metadata.
    ‚îî‚îÄ‚îÄ **Manual Context Management**: Use `manage_context("update_property", ...)` to update contexts property.

**III. Agent Role Switching Process**
‚Üí **Manual Trigger**: Agent role switching is triggered by **explicitly using the `call_agent` tool** (e.g., `call_agent(name_agent="coding_agent")`).
    ‚îú‚îÄ‚îÄ **Specify Agent Name**: Use the agent name directly in `call_agent()`.
    ‚îú‚îÄ‚îÄ **Normalize Agent Name**: The "@" prefix is stripped to get a clean agent name (e.g., "@coding_agent" ‚Üí "coding_agent").
    ‚îú‚îÄ‚îÄ **Execute Agent Call**: The system calls `call_agent(name_agent="...")`.
    ‚îî‚îÄ‚îÄ **AI Role Switch**: The AI assistant then adopts the specialized agent's expertise, knowledge base, behavioral patterns, problem-solving approaches, quality standards, and tool preferences. The AI is now ready to work with appropriate expertise.

**IV. Context-Driven Work & Progress Tracking**
‚Üí **Manual Context Creation**: Use `manage_context("create", task_id="...", project_id="...", task_tree_id="...")` to create task contexts when needed.
‚Üí **Check Context Before Starting Work**: Use `manage_context("get", task_id="...", project_id="...", task_tree_id="...")` to retrieve the current task context.
    ‚îú‚îÄ‚îÄ **During Implementation**: Log progress with `add_progress` and `add_insight` actions.
    ‚îÇ   ‚îî‚îÄ‚îÄ **Agent Insights Categories**: When adding insights, use specific categories: `insight` (general observations), `challenge` (problems encountered), `solution` (how challenges were resolved), and `decision` (important choices made).
    ‚îú‚îÄ‚îÄ **When Completing Steps**: Update `next_steps` in the context to maintain session continuity and guide subsequent actions.
    ‚îî‚îÄ‚îÄ **Update Context Properties**: For efficient and specific updates, use **dot notation** (e.g., `metadata.status` to update task status, `progress.next_steps.0` for the first next step).

### Important Rules & Best Practices for AI Agents

*   **DO NOT EDIT DATA JSON FILES DIRECTLY**: This is a **critical rule**. All data (tasks, projects, agents, contexts) must be managed **exclusively through MCP tools** (e.g., `manage_project`, `manage_agent`, `manage_task`, `manage_subtask`, `manage_context`) to ensure data integrity and system automation.
*   **Project Structure Awareness**:
    *   **dhafnck_mcp (ROOT)**: Contains full `.cursor/rules/` structure for development
    *   **Client Projects**: NO `.cursor/rules/` directories - data managed remotely via MCP
    *   **Docker/Cloud**: Data stored in container or cloud infrastructure
*   **Task ID Usage**:
    *   **Use the full date-based format** for all new tasks and subtasks.
    *   **Let the system auto-generate IDs**; do not create them manually.
    *   **Always quote IDs** when using them in tool calls (e.g., `"20250617001"`).
*   **Agent Assignment**:
    *   **Always use the `@` prefix** for agent assignees in tasks (e.g., `["@coding_agent"]`).
    *   **Assign only one primary agent per task** for clarity and predictable behavior. Multi-agent collaboration is handled through task decomposition.
    *   Register and assign agents using MCP tools, not by editing JSON.
*   **Context Management**:
    *   **Manually create contexts** using `manage_context("create", ...)` when context of task actual is not created.
    *   **Always check the task context before starting work** using `manage_context("get", ...)`.
    *   **Regularly log progress** using `add_progress` and `add_insight` actions.
    *   **Update `next_steps`** to maintain session continuity.
    *   When encountering issues, add `challenge` and `solution` insights. Document important `decision`s made.
    *   Use **dot notation** (e.g., `metadata.status`, `progress.next_steps.0`) for efficient and specific updates to context properties.
*   **YAML Configuration**: Keep agent YAML configs in `/yaml-lib/[agent_name]/` up to date. Ensure `job_desc.yaml` and at least one `rules/context` file exist **(in dhafnck_mcp development only)**.
*   **Specify Full Context**: Always include `project_id` and `task_tree_id` in all task and context operations to ensure correct hierarchical access.

### Index for Easy Content Check

*   **System Overview**: Purpose, architecture, key features, deployment model.
*   **Core Components**:
    *   **Tasks**: Definition, storage, required fields, ID format, statuses, auto-generation.
    *   **Projects**: Definition, storage, task trees.
    *   **Agents**: Definition, registration, assignment, YAML config, simplified format.
    *   **Contexts**: Definition, manual creation, storage, schema, insight categories, properties, dot notation.
*   **Key Rules for AI**:
    *   **Never Edit JSON Directly**: Always use MCP tools.
    *   **Project Structure**: dhafnck_mcp vs client projects.
    *   **Task ID Usage**: Auto-generate, date-based format, quoting IDs.
    *   **Agent Assignment**: `@` prefix, single primary agent.
    *   **Context Usage**: Check before work, log progress, update next steps, use dot notation, insight categories.
    *   **YAML Configs**: Keep up to date.
    *   **Specify Context**: Use `project_id` and `task_tree_id`.
*   **MCP Tool Integration**: Examples of `manage_project`, `manage_agent`, `manage_task`, `manage_context`, `call_agent`.
*   **Data Storage Locations (Source of Truth)**: `projects.json`, `tasks.json` (hierarchical), context storage varies by deployment.
*   **Deployment Architecture**: ROOT project vs client projects, Docker/cloud storage.
*   **Troubleshooting**: Common issues, e.g., agent not switching, task not found, ID format errors, missing config, project structure confusion.